# set Android specific options

import os
from waflib import Context, Errors
from waflib.Logs import info,warn,pprint
from waflib.TaskGen import feature, before_method, after_method
from waflib.Configure import conf

def options(opt):
	gr = opt.get_option_group('SDK paths and options')
	gr.add_option( '--android-sdk',
					action='store',
					default='',
					dest='android_sdk',
					help='Version of the Android SDK to target')

def get_android_arch(arch):
	archs = {
		'mipsel': 'mips',
	}
	return archs.get(arch, arch)

def find_android_gcc_toolchain(path, arch):
	try:
		path,bin = os.path.split(path)
		path,host = os.path.split(path)
		path,prebuilt = os.path.split(path)
		path,toolchain = os.path.split(path)
		path,_ = os.path.split(path)
		while _:
			toolchain_dir = os.path.join(path, 'toolchains')
			if os.path.isdir(toolchain_dir):
				all_toolchains = os.listdir(toolchain_dir)
				valid_toolchains = [t for t in all_toolchains if t.startswith('%s-'%arch)]
				valid_gcc_toolchains = []
				for t in valid_toolchains:
					if os.path.isdir(os.path.join(toolchain_dir, t, 'prebuilt', host)):
						for bindir in os.listdir(os.path.join(toolchain_dir, t, 'prebuilt', host)):
							if os.path.isdir(os.path.join(toolchain_dir, t, 'prebuilt', host, bindir, 'bin')):
								valid_gcc_toolchains.append((t, bindir))
				if valid_gcc_toolchains:
					selected_toolchain, bindir = valid_gcc_toolchains[-1]
					return os.path.join(toolchain_dir, selected_toolchain, 'prebuilt', host), bindir
			path,_ = os.path.split(path)
	except Exception as e:
		print(e)
	return None,None


def find_android_sdk(path, arch, hint):
	arch = get_android_arch(arch)
	try:
		path,_ = os.path.split(path)
		while _:
			platforms = os.path.join(path, 'platforms')
			if os.path.isdir(platforms):
				all_sdks = [p for p in os.listdir(platforms) if os.path.isdir(os.path.join(platforms, p, 'arch-%s'%arch))]
				if all_sdks:
					sdks = sorted(all_sdks, key = lambda x: int(x.split('-')[1]))
					sdk = sdks[-1]
					from waflib import Options
					favorite_sdk = Options.options.android_sdk or hint
					if favorite_sdk:
						if 'android-%s'%favorite_sdk in sdks:
							sdk = 'android-%s'%favorite_sdk
						else:
							warn('could not find android SDK version %s in path %s; using %s'%(favorite_sdk, path, sdk))
					return os.path.join(platforms, sdk, 'arch-%s'%arch), sdk.split('-')[1], 
			path,_ = os.path.split(path)
	except Exception as e:
		print(e)

@conf
def set_android_gcc_options(conf, options, arch):
	conf.env.append_unique('CFLAGS', ['-fPIC', '-fno-exceptions'])
	conf.env.append_unique('CXXFLAGS', ['-fPIC', '-fno-exceptions'])
	conf.env.append_unique('LINKFLAGS', [])
	conf.env.append_unique('LINKFLAGS_cprogram', ['-shared'])
	conf.env.append_unique('LINKFLAGS_cxxprogram', ['-shared'])
	conf.env.append_unique('CFLAGS_nowarning', ['-w'])
	conf.env.append_unique('CXXFLAGS_nowarning', ['-w'])
	conf.env.cprogram_PATTERN = 'lib%s.so'
	conf.env.cxxprogram_PATTERN = 'lib%s.so'
	conf.env.CFLAGS_cxxshlib = []
	conf.env.CXXFLAGS_cxxshlib = []

	if arch.startswith('arm'):
		conf.env.append_unique('CFLAGS', ['-march=armv7', '-mfpu=neon', '-mthumb'])
		conf.env.append_unique('CXXFLAGS', ['-march=armv7', '-mfpu=neon', '-mthumb'])

@conf
def set_android_clang_options(conf, flags, arch):
	conf.env.DEST_BINFMT = 'elf'
	conf.env.append_unique('CFLAGS', flags+['-fPIC'])
	conf.env.append_unique('CXXFLAGS', flags+['-fPIC'])
	conf.env.append_unique('LINKFLAGS', flags+[])
	conf.env.append_unique('CFLAGS_nowarning', ['-w'])
	conf.env.append_unique('CXXFLAGS_nowarning', ['-w'])
	conf.env.CFLAGS_cxxshlib = []
	conf.env.CXXFLAGS_cxxshlib = []

	if arch.startswith('arm'):
		conf.env.append_unique('CFLAGS', ['-march=armv7', '-mfpu=neon', '-mthumb'])
		conf.env.append_unique('CXXFLAGS', ['-march=armv7', '-mfpu=neon', '-mthumb'])
@conf
def set_android_options(conf, arch, sdk_hint):
	conf.env.VALID_PLATFORMS = ['android', 'posix']
	try:
		conf.start_msg('Looking for SDK')
		sdk, version = find_android_sdk(conf.env.CC[0], arch, sdk_hint)
		conf.env.ANDROID_SDK = version
	except Exception as e:
		conf.end_msg('none', color='RED')
		raise Errors.WafError(str(e))
	conf.end_msg(sdk)
	conf.env.cxxprogram_PATTERN = '%s'
	conf.env.DEPLOY_ROOTDIR = ''
	conf.env.DEPLOY_BINDIR = 'bin'
	conf.env.DEPLOY_RUNBINDIR = 'bin'
	conf.env.DEPLOY_LIBDIR = 'lib'
	conf.env.DEPLOY_INCLUDEDIR = 'include'
	conf.env.DEPLOY_DATADIR = os.path.join('share', 'bugengine')
	conf.env.DEPLOY_PLUGINDIR = os.path.join('share', 'bugengine', 'plugin')
	conf.env.DEPLOY_KERNELDIR = os.path.join('share', 'bugengine', 'kernel')

	conf.env.SYSROOT = [sdk]
	conf.env.append_unique('CFLAGS', ['--sysroot', sdk])
	conf.env.append_unique('CXXFLAGS', ['--sysroot', sdk])
	conf.env.append_unique('LINKFLAGS', ['--sysroot', sdk])

def configure(conf):
	seen = set([])
	android_clang_archs = ['arm', 'mipsel', 'x86']
	os = 'android'
	for version, directory, target, arch in conf.env.CLANG_TARGETS:
		android_toolchains = []
		android_archs = []
		real_arch, flags = arch
		sdk_number = ''
		for real_arch in android_clang_archs:
			gcc, triple = find_android_gcc_toolchain(directory, real_arch)
			if gcc:
				flags = ['-gcc-toolchain', gcc, '-target', triple]
				toolchain = '%s-%s-%s-%s'%(os, real_arch, 'clang', version)
				if toolchain not in seen:
					seen.add(toolchain)
					env = conf.env.derive()
					conf.setenv(toolchain, env)
					env.DEST_OS = 'android'
					try:
						conf.start_msg('Setting up compiler')
						conf.load_clang(directory)
						conf.set_android_clang_options(flags, real_arch)
					except Exception as e:
						conf.end_msg(e, color='RED')
						raise
					else:
						conf.end_msg('done')
						try:
							conf.set_android_options(real_arch, sdk_number)
							toolchain = '%s-%s-%s-%s'%(os+conf.env.ANDROID_SDK, real_arch, 'clang', version)
							conf.setenv(toolchain, conf.env.derive())
							conf.env.KERNEL_TOOLCHAINS = [toolchain]
							conf.env.ENV_PREFIX = real_arch
							conf.add_toolchain(os+conf.env.ANDROID_SDK, real_arch, 'clang', version, real_arch, False)
							sdk_number = conf.env.ANDROID_SDK
						except Errors.WafError as e:
							conf.variant = ''
							pprint('YELLOW', '%s failed: %s' % (toolchain, e))
						except Exception as e:
							conf.variant = ''
							pprint('RED', '%s failed: %s' % (toolchain, e))
							raise
						else:
							android_toolchains.append(toolchain)
							android_archs.append(real_arch)
							conf.variant = ''
		if android_toolchains:
			toolchain = '%s%s-%s-%s-%s'%(os, sdk_number, ','.join(android_archs), 'clang', version)
			env = conf.env.derive()
			conf.setenv(toolchain, env)
			conf.env.VALID_PLATFORMS = ['android', 'posix']
			conf.env.VALID_ARCHITECTURES = android_archs
			conf.env.SUB_TOOLCHAINS = android_toolchains
			conf.add_multiarch_toolchain(toolchain)
			pprint('GREEN', 'configured for toolchain %s' % (toolchain))

	gcc_targets = {}
	for name, bindir, gcc, gxx, version, target, arch, options in conf.env.GCC_TARGETS:
		position = target.find('android')
		if position != -1:
			try:
				gcc_targets['%s-%s' % (name, version)].append((name, bindir, gcc, gxx, version, target, arch, options))
			except KeyError:
				gcc_targets['%s-%s' % (name, version)] = [(name, bindir, gcc, gxx, version, target, arch, options)]
	for gcc_version, gcc_variables in gcc_targets.items():
		seen = set([])
		android_toolchains = []
		android_archs = []
		sdk_number = ''
		for name, bindir, gcc, gxx, version, target, arch, options in gcc_variables:
			toolchain = '%s-%s-%s-%s'%(os, arch, name, version)
			if toolchain not in seen:
				seen.add(toolchain)
				env = conf.env.derive()
				conf.setenv(toolchain, env)
				env.DEST_OS = 'android'
				try:
					conf.start_msg('Setting up compiler')
					conf.load_gcc(bindir, gcc, gxx, version, target, arch, options)
					conf.set_android_gcc_options(options, arch)
				except Exception as e:
					conf.end_msg(e, color='RED')
					raise
				else:
					conf.end_msg('done')
					try:
						conf.set_android_options(arch, sdk_number)
						toolchain = '%s-%s-%s-%s'%(os+conf.env.ANDROID_SDK, arch, name, version)
						conf.setenv(toolchain, conf.env.derive())
						conf.env.KERNEL_TOOLCHAINS = [toolchain]
						conf.add_toolchain(os+conf.env.ANDROID_SDK, arch, name, version, arch, False)
						sdk_number = conf.env.ANDROID_SDK
					except Errors.WafError as e:
						conf.variant = ''
						pprint('YELLOW', '%s failed: %s' % (toolchain, e))
					except Exception as e:
						conf.variant = ''
						pprint('RED', '%s failed: %s' % (toolchain, e))
						raise
					else:
						android_toolchains.append(toolchain)
						android_archs.append(arch)
						conf.variant = ''
		if android_toolchains:
			toolchain = '%s%s-%s-%s-%s'%(os, sdk_number, ','.join(android_archs), name, version)
			env = conf.env.derive()
			conf.setenv(toolchain, env)
			conf.env.VALID_PLATFORMS = ['android', 'posix']
			conf.env.VALID_ARCHITECTURES = android_archs
			conf.env.SUB_TOOLCHAINS = android_toolchains
			conf.add_multiarch_toolchain(toolchain)
			pprint('GREEN', 'configured for toolchain %s' % (toolchain))



def build(bld):
	bld.platforms.append(bld.external('3rdparty.stl-gabi++'))

def plugins(bld):
	pass

